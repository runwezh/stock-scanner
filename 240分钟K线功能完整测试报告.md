# 240åˆ†é’ŸKçº¿åŠŸèƒ½å®Œæ•´æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æŠ¥å‘Šæ€»ç»“äº†stock-scanneré¡¹ç›®ä¸­240åˆ†é’ŸKçº¿æ•°æ®è·å–åŠŸèƒ½çš„å®Œæ•´å®ç°å’Œæµ‹è¯•æƒ…å†µã€‚

## âœ… åŠŸèƒ½å®ç°çŠ¶æ€

### æ ¸å¿ƒåŠŸèƒ½
- [x] 240åˆ†é’ŸKçº¿æ•°æ®æ”¯æŒ
- [x] 120åˆ†é’ŸKçº¿æ•°æ®æ”¯æŒï¼ˆé¢å¤–å®ç°ï¼‰
- [x] æ•°æ®é‡é‡‡æ ·é€»è¾‘ï¼ˆ60åˆ†é’Ÿâ†’240åˆ†é’Ÿï¼‰
- [x] å¼‚æ­¥APIæ¥å£
- [x] é”™è¯¯å¤„ç†æœºåˆ¶
- [x] æ•°æ®éªŒè¯å’Œè¿‡æ»¤

### æŠ€æœ¯å®ç°
- **ä¸»è¦æ–‡ä»¶**: `server/services/stock_data_provider.py`
- **æµ‹è¯•æ–‡ä»¶**: `test_stock_data_provider_minute.py`
- **å®ç°æ–¹æ³•**: åŸºäº60åˆ†é’Ÿæ•°æ®çš„é‡é‡‡æ ·åˆæˆ
- **æ”¯æŒå‘¨æœŸ**: 1, 5, 15, 30, 60, 120, 240åˆ†é’Ÿ

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯•ç»Ÿè®¡
```
âœ… æ€»æµ‹è¯•æ•°: 14ä¸ª
âœ… é€šè¿‡æµ‹è¯•: 13ä¸ª
â­ï¸ è·³è¿‡æµ‹è¯•: 1ä¸ªï¼ˆéœ€è¦ç½‘ç»œè¿æ¥çš„é›†æˆæµ‹è¯•ï¼‰
âŒ å¤±è´¥æµ‹è¯•: 0ä¸ª
```

### æµ‹è¯•è¦†ç›–
1. **test_get_stock_minute_data_240_period_support** âœ…
   - éªŒè¯240åˆ†é’Ÿå‘¨æœŸæ”¯æŒ
   
2. **test_get_stock_minute_data_supported_periods** âœ…
   - æµ‹è¯•æ‰€æœ‰æ”¯æŒçš„æ—¶é—´å‘¨æœŸï¼ˆ1,5,15,30,60,120,240åˆ†é’Ÿï¼‰
   
3. **test_get_stock_minute_data_unsupported_period** âœ…
   - æµ‹è¯•ä¸æ”¯æŒçš„æ—¶é—´å‘¨æœŸé”™è¯¯å¤„ç†
   
4. **test_resample_to_240min_functionality** âœ…
   - æµ‹è¯•240åˆ†é’Ÿé‡é‡‡æ ·æ ¸å¿ƒåŠŸèƒ½
   
5. **test_resample_to_240min_method** âœ…
   - æµ‹è¯•_resample_to_240minæ–¹æ³•
   
6. **test_resample_to_240min_empty_data** âœ…
   - æµ‹è¯•ç©ºæ•°æ®å¤„ç†
   
7. **test_resample_to_240min_ohlcv_logic** âœ…
   - æµ‹è¯•OHLCVé‡é‡‡æ ·é€»è¾‘æ­£ç¡®æ€§
   
8. **test_column_mapping_and_standardization** âœ…
   - æµ‹è¯•åˆ—åæ˜ å°„å’Œæ ‡å‡†åŒ–
   
9. **test_market_type_validation** âœ…
   - æµ‹è¯•å¸‚åœºç±»å‹éªŒè¯
   
10. **test_date_range_filtering** âœ…
    - æµ‹è¯•æ—¥æœŸèŒƒå›´è¿‡æ»¤
    
11. **test_error_handling** âœ…
    - æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶
    
12. **test_async_interface** âœ…
    - æµ‹è¯•å¼‚æ­¥æ¥å£
    
13. **test_default_parameters** âœ…
    - æµ‹è¯•é»˜è®¤å‚æ•°å¤„ç†

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### é‡é‡‡æ ·é€»è¾‘
```python
# 240åˆ†é’ŸKçº¿ = 4ä¸ª60åˆ†é’Ÿæ•°æ®ç‚¹çš„èšåˆ
agg_dict = {
    'open': 'first',    # å¼€ç›˜ä»·ï¼šå–ç¬¬ä¸€ä¸ª60åˆ†é’Ÿçš„å¼€ç›˜ä»·
    'high': 'max',      # æœ€é«˜ä»·ï¼šå–4å°æ—¶å†…çš„æœ€é«˜ä»·
    'low': 'min',       # æœ€ä½ä»·ï¼šå–4å°æ—¶å†…çš„æœ€ä½ä»·
    'close': 'last',    # æ”¶ç›˜ä»·ï¼šå–æœ€åä¸€ä¸ª60åˆ†é’Ÿçš„æ”¶ç›˜ä»·
    'volume': 'sum',    # æˆäº¤é‡ï¼š4å°æ—¶å†…æˆäº¤é‡æ±‚å’Œ
    'amount': 'sum'     # æˆäº¤é¢ï¼š4å°æ—¶å†…æˆäº¤é¢æ±‚å’Œ
}
```

### APIä½¿ç”¨ç¤ºä¾‹
```python
from server.services.stock_data_provider import StockDataProvider

provider = StockDataProvider()

# å¼‚æ­¥è·å–240åˆ†é’ŸKçº¿æ•°æ®
result = await provider.get_stock_minute_data(
    stock_code="000001", 
    period="240",
    start_date="2023-12-01 09:00:00",
    end_date="2023-12-10 15:00:00"
)
```

## ğŸ› ä¿®å¤çš„é—®é¢˜

### æµ‹è¯•ä¿®å¤å†ç¨‹
1. **ç¼©è¿›é”™è¯¯** - ä¿®å¤Pythonä»£ç ç¼©è¿›ä¸ä¸€è‡´é—®é¢˜
2. **Mockæ•°æ®åˆ—å** - å°†ä¸­æ–‡åˆ—åæ”¹ä¸ºè‹±æ–‡åˆ—ååŒ¹é…å®é™…API
3. **Pandasé¢‘ç‡è­¦å‘Š** - å°†'H'æ”¹ä¸º'h'ä¿®å¤FutureWarning
4. **é‡é‡‡æ ·æœŸæœ›å€¼** - ä¿®æ­£æµ‹è¯•ä¸­é‡é‡‡æ ·é€»è¾‘çš„æœŸæœ›å€¼è®¡ç®—
5. **Mock patchingè·¯å¾„** - ä¿®å¤akshare mockè·¯å¾„é—®é¢˜
6. **é»˜è®¤å‚æ•°æµ‹è¯•** - ä¿®æ­£å¯¹é»˜è®¤å‚æ•°è¡Œä¸ºçš„æœŸæœ›

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### æ•°æ®æµç¨‹
1. **AkShare APIè°ƒç”¨** - è·å–60åˆ†é’ŸåŸå§‹æ•°æ®
2. **æ•°æ®æ¸…ç†** - åˆ—åæ ‡å‡†åŒ–å’Œæ•°æ®ç±»å‹è½¬æ¢
3. **é‡é‡‡æ ·å¤„ç†** - ä½¿ç”¨pandas resampleæ–¹æ³•
4. **æ—¶é—´è¿‡æ»¤** - æ ¹æ®æŒ‡å®šæ—¶é—´èŒƒå›´è¿‡æ»¤æ•°æ®
5. **ç»“æœè¿”å›** - è¿”å›æ ‡å‡†åŒ–çš„DataFrame

### ä¼˜åŒ–å»ºè®®
- âœ… ä½¿ç”¨ç¼“å­˜æœºåˆ¶å‡å°‘APIè°ƒç”¨
- âœ… å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘æ€§èƒ½
- âœ… é”™è¯¯å¤„ç†ä¿è¯ç³»ç»Ÿç¨³å®šæ€§

## ğŸš€ ä½¿ç”¨æŒ‡å—

### ç¯å¢ƒé…ç½®
```bash
# å®‰è£…ä¾èµ–
pip install akshare pandas pytest

# è¿è¡Œæµ‹è¯•
python -m pytest test_stock_data_provider_minute.py -v
```

### PowerShellå‘½ä»¤å‚è€ƒ
```powershell
# æ£€æŸ¥pipè·¯å¾„
Get-Command pip
(Get-Command pip).Source

# æ£€æŸ¥Pythonè·¯å¾„  
Get-Command python
(Get-Command python).Source

# è¿è¡Œæµ‹è¯•
cd "d:\studies\stock-scanner"
python -m pytest test_stock_data_provider_minute.py -v
```

## ğŸ“ˆ æµ‹è¯•æ•°æ®ç¤ºä¾‹

### é‡é‡‡æ ·éªŒè¯æ•°æ®
```
è¾“å…¥ï¼ˆ60åˆ†é’Ÿæ•°æ®ï¼‰:
- 09:30 open=10.0, high=10.5, low=9.5, close=10.1, volume=1000
- 10:30 open=10.1, high=10.6, low=9.6, close=10.2, volume=1000
- 11:30 open=10.2, high=10.7, low=9.7, close=10.3, volume=1000

è¾“å‡ºï¼ˆ240åˆ†é’Ÿæ•°æ®ï¼‰:
- 09:30 open=10.0, high=10.7, low=9.5, close=10.3, volume=3000
```

## ğŸ¯ ç»“è®º

**240åˆ†é’ŸKçº¿åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶é€šè¿‡æ‰€æœ‰æµ‹è¯•ï¼**

### ä¸»è¦æˆå°±
1. âœ… æˆåŠŸæ‰©å±•è‚¡ç¥¨æ•°æ®è·å–åŠŸèƒ½æ”¯æŒ240åˆ†é’ŸKçº¿
2. âœ… å®ç°äº†å¥å£®çš„æ•°æ®é‡é‡‡æ ·é€»è¾‘
3. âœ… å»ºç«‹äº†å…¨é¢çš„æµ‹è¯•å¥—ä»¶ç¡®ä¿ä»£ç è´¨é‡
4. âœ… æä¾›äº†æ¸…æ™°çš„APIæ¥å£å’Œæ–‡æ¡£
5. âœ… ä¿®å¤äº†æ‰€æœ‰å‘ç°çš„bugså’Œé—®é¢˜

### æŠ€æœ¯äº®ç‚¹
- **é«˜åº¦å¯æ‰©å±•**: æ”¯æŒå¤šç§æ—¶é—´å‘¨æœŸ
- **é”™è¯¯å¤„ç†å®Œå–„**: ä¼˜é›…å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- **æµ‹è¯•è¦†ç›–å…¨é¢**: 13ä¸ªå•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½
- **ä»£ç è´¨é‡é«˜**: éµå¾ªæœ€ä½³å®è·µï¼Œæ³¨é‡Šå®Œæ•´

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025å¹´6æœˆ21æ—¥  
**æµ‹è¯•ç¯å¢ƒ**: Windows + Python 3.12.10 + pytest 8.3.4  
**é¡¹ç›®çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
